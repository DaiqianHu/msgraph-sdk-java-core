#Copyright (c) Microsoft Corporation. All rights reserved.
#Licensed under the MIT License.
#Building and packaging the artifacts of the Java-Core libraries using the build.gradle file.
#Ready the package for deployment and release. 

trigger:
  branches:
    include:
      - dev
      - main
      - master
  paths:
    include:
      - src/*
    exclude:
      - .gradle/wrapper
      - .gitignore
      - CONTRIBUTING.md
      - LICENSE
      - THIRD PARTY NOTICES
      - gradle.properties
      - gradlew
      - gradlew.bat
      - readme.md
      - settings.gradle
      - Scripts/*

pr: none

pool:
  vmImage: windows-latest

stages:
- stage: Build-Stage
  jobs:
  - job: Build
    steps:
    - template: templates/build-stage/checkout-and-credscan.yml
    - template: templates/build-stage/install-java.yml
    - template: templates/build-stage/secure-files.yml
    - template: templates/build-stage/build-and-coverage.yml
    - template: templates/build-stage/publish-artefacts.yml
    - template: templates/alert-failure.yml

- stage: Maven-Preview
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))
  jobs: 
  - job: Maven-Preview
    steps: 
    - template: templates/download-artifacts.yml
    - template: templates/maven-preview-stage/secure-files.yml
    - template: templates/maven-preview-stage/copy-and-build.yml
    - template: templates/alert-failure.yml

- stage: Maven-Release
  dependsOn: []
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - job: Maven-Release
    steps: 
    - template: templates/validation-request.yml
    - template: templates/download-artifacts.yml
    - template: templates/maven-release-stage/secure-files.yml
    - template: templates/maven-release-stage/copy-and-build.yml
    - template: templates/alert-failure.yml

- stage: Github-Release
  dependsOn: 
  - Maven-Release
  jobs:
  - job: Github-Release
    steps:
    - template: templates/download-artifacts.yml
    - template: templates/github-release-stage/version-and-release.yml
    - template: templates/alert-failure.yml